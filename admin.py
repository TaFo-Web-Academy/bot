# admin.py
import logging
from telegram import Update
from telegram.ext import ContextTypes
from database import Database
from config import ADMIN_IDS
import os

db = Database()
logger = logging.getLogger(__name__)


async def admin_export(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ² Excel Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²"""
    if update.effective_user.id not in ADMIN_IDS:
        await update.message.reply_text("âŒ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰ĞµĞ½")
        logger.warning(f"ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº /export Ğ¾Ñ‚ Ğ½ĞµĞ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {update.effective_user.id}")
        return

    try:
        logger.info(f"ğŸ“Š Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑˆĞµĞ½ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ¼ {update.effective_user.id}")
        filename = db.export_to_excel()
        with open(filename, 'rb') as file:
            await update.message.reply_document(
                document=file,
                caption=f"ğŸ“Š Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ({db.get_users_count()} Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹)"
            )
        os.remove(filename)
        logger.info(f"âœ… Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½")
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ°: {e}", exc_info=True)
        await update.message.reply_text(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ°: {e}")


async def admin_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²"""
    if update.effective_user.id not in ADMIN_IDS:
        await update.message.reply_text("âŒ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰ĞµĞ½")
        logger.warning(f"ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº /stats Ğ¾Ñ‚ Ğ½ĞµĞ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {update.effective_user.id}")
        return

    try:
        count = db.get_users_count()
        users = db.get_all_users()[:5]

        stats_text = (
            "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
            "â•‘   ğŸ“ˆ Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ    â•‘\n"
            "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n"
            f"ğŸ‘¥ Ğ’ÑĞµĞ³Ğ¾ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²: {count}\n\n"
            "ğŸ“‹ ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸:\n"
            "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
        )

        for i, user in enumerate(users, 1):
            stats_text += f"{i}. @{user[1]} - {user[2]} ({user[3]} Ğ±Ğ°Ğ»Ğ»Ğ°)\n"

        await update.message.reply_text(stats_text)
        logger.info(f"âœ… Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ {update.effective_user.id}")
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸: {e}", exc_info=True)
        await update.message.reply_text(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: {e}")


async def admin_broadcast(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ²ÑĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼"""
    if update.effective_user.id not in ADMIN_IDS:
        await update.message.reply_text("âŒ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰ĞµĞ½")
        logger.warning(f"ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº /broadcast Ğ¾Ñ‚ Ğ½ĞµĞ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {update.effective_user.id}")
        return

    if not context.args:
        await update.message.reply_text(
            "ğŸ“¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:\n"
            "/broadcast <ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ>\n\n"
            "ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:\n"
            "/broadcast ĞĞ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°ĞµĞ¼ Ğ¾ Ñ‚Ñ€ĞµĞ½Ğ¸Ğ½Ğ³Ğµ Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°!"
        )
        return

    message = ' '.join(context.args)
    users = db.get_all_users()
    success = 0
    failed = 0

    logger.info(f"ğŸ“¢ ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ° Ğ´Ğ»Ñ {len(users)} Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹")

    status_message = await update.message.reply_text(
        f"ğŸ“¤ ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºÑƒ...\n"
        f"Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹: {len(users)}"
    )

    for user in users:
        try:
            await context.bot.send_message(chat_id=user[0], text=message)
            success += 1
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {user[0]}: {e}")
            failed += 1

    result_text = (
        "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
        "â•‘  ğŸ“¢ Ğ ĞĞ¡Ğ¡Ğ«Ğ›ĞšĞ       â•‘\n"
        "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n"
        f"âœ… Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾: {success}\n"
        f"âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ: {failed}\n"
        f"ğŸ“Š Ğ’ÑĞµĞ³Ğ¾: {len(users)}"
    )

    await status_message.edit_text(result_text)
    logger.info(result_text)